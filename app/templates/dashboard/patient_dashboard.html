{% extends "base.html" %}
{% block content %}

<!-- Jinja se history page ka URL generate kar rahe hain -->
{% set history_url = url_for('dashboard.history') %}

<div class="min-h-screen bg-gray-50 py-12 px-6">
  <!-- Header -->
  <div class="max-w-4xl mx-auto text-center mb-12">
    <h1 class="text-5xl font-bold text-[#073a3b] mb-4">
      Record Your Message
    </h1>
    <p class="text-2xl text-gray-600">Upload your sign language keypoints</p>
  </div>

  <!-- Upload Card -->
  <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-10">
    
    <!-- Upload Form -->
    <form id="uploadForm" class="space-y-8">
      <!-- File Input -->
      <div>
        <label class="block text-lg font-semibold text-gray-700 mb-4">
          Select Keypoint File (Max 1MB)
        </label>
        <div class="border-2 border-dashed border-[#073a3b] rounded-2xl p-8 text-center cursor-pointer hover:bg-gray-50 transition"
             id="dropZone">
          <i class="fas fa-database text-[#073a3b] text-5xl mb-4"></i>
          <p class="text-lg font-medium text-gray-900">Click to select or drag file here</p>
          <p class="text-sm text-gray-500 mt-2">Supported: .npy keypoint files (Max 1MB)</p>
          <input type="file" id="videoInput" name="video" accept=".npy" class="hidden">
        </div>
        <div id="fileName" class="mt-4 text-center font-medium text-gray-600"></div>
      </div>

      <!-- Upload Button -->
      <button type="submit" id="uploadBtn"
        class="w-full px-10 py-5 bg-[#073a3b] text-white text-xl font-bold rounded-xl hover:bg-[#052d2e] transition disabled:opacity-50 disabled:cursor-not-allowed"
        disabled>
        Upload & Translate
      </button>

      <div id="status" class="text-center text-lg font-medium"></div>
    </form>
  </div>

</div>

<script>
  const videoInput = document.getElementById('videoInput');
  const dropZone = document.getElementById('dropZone');
  const uploadBtn = document.getElementById('uploadBtn');
  const status = document.getElementById('status');
  const fileName = document.getElementById('fileName');

  dropZone.addEventListener('click', () => videoInput.click());
  videoInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('bg-gray-100');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('bg-gray-100');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('bg-gray-100');
    handleFileSelect(e.dataTransfer.files[0]);
  });

  function handleFileSelect(file) {
    if (!file) return;

    if (file.size > 1 * 1024 * 1024) {
      status.innerHTML = '<span class="text-red-600">File too large! Max 1MB</span>';
      return;
    }

    if (!file.name.endsWith('.npy')) {
      status.innerHTML = '<span class="text-red-600">Please select a .npy keypoint file</span>';
      return;
    }

    fileName.textContent = `Selected: ${file.name}`;
    uploadBtn.disabled = false;
    status.innerHTML = '';
  }

  document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = videoInput.files[0];
    if (!file) {
      status.innerHTML = '<span class="text-red-600">Please select a file</span>';
      return;
    }

    uploadBtn.disabled = true;
    status.innerHTML = '<span class="text-blue-600">ðŸ“Š Analyzing keypoints...</span>';

    const formData = new FormData();
    formData.append('video', file);

    try {
      const response = await fetch('/dashboard/upload_video', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        status.innerHTML = `
          <span class="text-green-600 text-2xl font-bold">Keypoints analyzed successfully!</span><br>
          <p class="mt-4 text-gray-700">Translation: "${data.translation}"</p>
          <p class="mt-4"><a href="{{ history_url }}" class="text-[#073a3b] font-semibold underline">View Conversation History â†’</a></p>
        `;
        videoInput.value = '';
        fileName.textContent = '';
      } else {
        status.innerHTML = `<span class="text-red-600">${data.error || 'Upload failed'}</span>`;
      }
    } catch (error) {
      console.error(error);
      status.innerHTML = `<span class="text-red-600">Upload failed: ${error.message}</span>`;
    } finally {
      uploadBtn.disabled = false;
    }
  });
</script>

{% endblock %}